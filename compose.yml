services:
  app-service:
    image: ddresser05/app-service # specify name of image on Docker Hub
    profiles: ["prod", "dev"]
    restart: "always" # automatically restart container when server crashes
    environment: # set up environment variables
      AUTH_SERVICE_IP: ${AUTH_SERVICE_IP:-localhost} # Use localhost as the default value
    ports:
      - "8000:8000" # expose port 8000 so that applications outside the container can connect to it 
    networks:
      - app-network
    depends_on: # only run app-service after auth-service has started
      auth-service:
        condition: service_started
  auth-service:
    image: ddresser05/auth-service
    profiles: ["prod", "dev"]
    restart: "always"
    environment:
      JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: "postgres://postgres:${POSTGRES_PASSWORD}@db:5432"
    ports:
      - "3000:3000"
    depends_on:
      - db
    networks:
      - app-network
  db:
    image: postgres:15.2-alpine
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - db:/var/lib/postgresql/data
  webserver:
    image: nginx:latest # use the latest version of nginx
    profiles: ["prod"]
    restart: "always" # automatically restart container when server crashes
    ports:
      - "80:80" # expose port 80 so that applications outside the container can connect to it 
      - "443:443" # expose port 443 for HTTPS traffic
    volumes:
      - webroot:/var/www/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf # mount nginx.conf from project root
      - certbot-etc:/etc/letsencrypt # mount local certbot configuration directory into the container
      - certbot-var:/var/lib/letsencrypt # mount local certbot data directory into the container
      - ./dhparam:/etc/ssl/certs # mount dhparam directory from project root
    networks:
      - app-network
    depends_on: # only run webserver after app-service and auth-service have started
      app-service:
        condition: service_started
      auth-service:
        condition: service_started 
  certbot:
    image: certbot/certbot # use the official certbot image
    profiles: ["prod"]
    restart: "no" # Don't restart - certbot should run once and exit
    volumes:
      - certbot-etc:/etc/letsencrypt # mount local certbot configuration directory into the container
      - certbot-var:/var/lib/letsencrypt # mount local certbot data directory into the container
      - webroot:/var/www/html # mount local web root directory into the container
    networks:
      - app-network
    depends_on:
      - webserver
    command: certonly --webroot --webroot-path=/var/www/html --email ${CERTBOT_EMAIL} --agree-tos --no-eff-email --keep-until-expiring --non-interactive -d lgr.ddrcode.me -d www.lgr.ddrcode.me
volumes:
  certbot-etc:
  certbot-var:
  webroot:
  db:
    driver: local
networks:
  app-network:
    driver: bridge